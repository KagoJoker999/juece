// Supabaseæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œæ­¤è„šæœ¬æ¥åˆå§‹åŒ–æ•°æ®åº“è¡¨

const SUPABASE_URL = 'https://xjjzgxqrxddbqsdcqeqa.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqamFneGFxcnhkZGJxc2RjcWVxYSIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzM0MDcwODkwLCJleHAiOjIwNDk2NDY4OTB9.sG5pP6Lq8o8e2wQ2aWq2pN8lY3vj7qC9rM1b4vZ6y5m';

// åˆ›å»ºè¡¨çš„SQL
const CREATE_TABLE_SQL = `
CREATE TABLE IF NOT EXISTS express_compensation_records (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tracking_number text NOT NULL,
    amount numeric(10,2) NOT NULL,
    record_type text NOT NULL CHECK (record_type IN ('compensation', 'advance')),
    is_paid boolean NOT NULL DEFAULT false,
    record_date date NOT NULL,
    note text,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_express_compensation_records_date ON express_compensation_records(record_date);
CREATE INDEX IF NOT EXISTS idx_express_compensation_records_type ON express_compensation_records(record_type);
CREATE INDEX IF NOT EXISTS idx_express_compensation_records_paid ON express_compensation_records(is_paid);

-- å¯ç”¨RLS
ALTER TABLE express_compensation_records ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºRLSç­–ç•¥ï¼ˆå…è®¸æ‰€æœ‰æ“ä½œï¼‰
DROP POLICY IF EXISTS "Users can view all records" ON express_compensation_records;
CREATE POLICY "Users can view all records" ON express_compensation_records FOR SELECT USING (true);

DROP POLICY IF EXISTS "Users can insert records" ON express_compensation_records;
CREATE POLICY "Users can insert records" ON express_compensation_records FOR INSERT WITH CHECK (true);

DROP POLICY IF EXISTS "Users can update records" ON express_compensation_records;
CREATE POLICY "Users can update records" ON express_compensation_records FOR UPDATE USING (true);

DROP POLICY IF EXISTS "Users can delete records" ON express_compensation_records;
CREATE POLICY "Users can delete records" ON express_compensation_records FOR DELETE USING (true);
`;

// å°è¯•åˆ›å»ºè¡¨
async function initializeDatabase() {
    try {
        console.log('å¼€å§‹åˆå§‹åŒ–Supabaseæ•°æ®åº“...');
        
        // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        const checkResponse = await fetch(`${SUPABASE_URL}/rest/v1/express_compensation_records?limit=1`, {
            method: 'GET',
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (checkResponse.ok) {
            console.log('âœ… æ•°æ®åº“è¡¨å·²å­˜åœ¨');
            return true;
        } else if (checkResponse.status === 404) {
            console.log('âš ï¸ æ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åœ¨Supabase SQL Editorä¸­æ‰§è¡Œä»¥ä¸‹SQL:');
            console.log(CREATE_TABLE_SQL);
            return false;
        } else {
            console.error('âŒ æ£€æŸ¥æ•°æ®åº“è¡¨æ—¶å‡ºé”™:', checkResponse.status, await checkResponse.text());
            return false;
        }
    } catch (error) {
        console.error('âŒ åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥:', error);
        return false;
    }
}

// è¿è¡Œåˆå§‹åŒ–
initializeDatabase().then(result => {
    if (result) {
        console.log('ğŸ‰ æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼');
    } else {
        console.log('ğŸ’¡ è¯·åœ¨Supabase SQL Editorä¸­è¿è¡Œä¸Šè¿°SQLè„šæœ¬ï¼Œç„¶ååˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    }
});